  //ä»¥ä¸‹ä¸ºbakaå›¾ç‰‡çš„å¤„ç†å‡½æ•°

  // const fullPath = path.resolve(ctx.baseDir, config.storagePath)
  // fs.mkdir(fullPath, { recursive: true })
  //   .then(() => ctx.logger('baka').info(`å­˜å‚¨ç›®å½•å·²åˆ›å»ºï¼š${fullPath}`))
  //   .catch(error => ctx.logger('baka').error(`ç›®å½•åˆ›å»ºå¤±è´¥ï¼š${error}`))


  // // å­˜å‚¨ç­‰å¾…æ·»åŠ å›¾ç‰‡çš„ç”¨æˆ·çŠ¶æ€
  // const pendingUsers = new Set<string>()

  // ctx.command('æ·»åŠ å›¾ç‰‡', 'æ·»åŠ bakaå›¾ç‰‡')
  //   .alias('add-image')
  //   .action(({ session }) => {
  //     if (!session) return
      
  //     pendingUsers.add(session.userId)
  //     return 'è¯·ç›´æ¥å‘é€è¦æ·»åŠ çš„å›¾ç‰‡'
  //   })



  // ctx.middleware(async (session, next) => {
  //   // æ¶ˆæ¯é¢„å¤„ç†
  //   const content = session.content
  //     .replace(/[\s\u3000]/g, '') // å»é™¤å…¨åŠè§’ç©ºæ ¼
  //     .replace(/[!?ã€‚ï¼Œ]/g, '')   // å»é™¤æ ‡ç‚¹
  //     .toLowerCase()
  //   ctx.logger('baka').debug(`é¢„å¤„ç†å†…å®¹ï¼š[${content}]`)
  //   if (content === 'baka') {
  //     try {
  //       ctx.logger('baka').info('è§¦å‘BAKAå…³é”®è¯')
  //       const images = await ctx.database.get('baka_images', {})
  //       if (images.length === 0) return 'æš‚æ— å¯ç”¨å›¾ç‰‡'
        
  //       const randomImage = images[Math.floor(Math.random() * images.length)]
  //       const imagePath = path.join(fullPath, randomImage.filename)
  //       return h.image(imagePath)
  //     } catch (error) {
  //       ctx.logger('white-saintess').error(error)
  //       return 'å›¾ç‰‡è·å–å¤±è´¥'
  //     }
  //   }

  //   // å¤„ç†å›¾ç‰‡æ·»åŠ æµç¨‹
  //   if (pendingUsers.has(session.userId)) {
  //     pendingUsers.delete(session.userId)
      
  //     const image = session.elements.find(e => e.type === 'image')
  //     if (!image) return 'æœªæ£€æµ‹åˆ°å›¾ç‰‡ï¼Œæ·»åŠ å·²å–æ¶ˆ'

  //     try {
  //       // ä¸‹è½½å›¾ç‰‡
  //       const url = image.attrs.url
  //       const response = await ctx.http.get(url, { responseType: 'arraybuffer' })
  //       const buffer = Buffer.from(response)

  //       // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
  //       const filename = `${randomUUID()}.${getFileExtension(url)}`
  //       const filePath = path.join(fullPath, filename)

  //       // ä¿å­˜æ–‡ä»¶
  //       await fs.writeFile(filePath, buffer)

  //       // å†™å…¥æ•°æ®åº“
  //       await ctx.database.create('baka_images', {
  //         filename,
  //         adder: session.userId,
  //         timestamp: new Date(),
  //       })

  //       return `å›¾ç‰‡æ·»åŠ æˆåŠŸï¼ä¿å­˜ä¸ºï¼š${filename}`
  //     } catch (error) {
  //       ctx.logger('white-saintess').error(error)
  //       return 'å›¾ç‰‡æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—'
  //     }
  //   }

  //   return next()
  // })
  // // ä» URL è·å–æ–‡ä»¶æ‰©å±•å
  // function getFileExtension(url: string): string {
  //   const match = url.match(/\.([a-z0-9]+)(?:[\?#]|$)/i)
  //   return match ? match[1].toLowerCase() : 'png'
  // }
  //1. ç›®å½•åˆå§‹åŒ–é”™è¯¯ç›‘æ§
  // const fullPath = path.resolve(ctx.baseDir, config.storagePath)
  // const maxSize = config.maxSizeMB * 1024 * 1024
  // let imageCache: ImageInfo[] = []
  // let lastUpdate = 0

  // // åˆå§‹åŒ–å­˜å‚¨ç›®å½•ï¼ˆå¸¦é”™è¯¯ç›‘æ§ï¼‰
  // const initialize = async () => {
  //   try {
  //     // 1. åˆ›å»ºå­˜å‚¨ç›®å½•
  //     await fs.mkdir(fullPath, { recursive: true })
  //     ctx.logger('baka').info(`ğŸ“ å­˜å‚¨ç›®å½•å·²å°±ç»ªï¼š${pathToFileURL(fullPath)}`)

  //     // 2. åˆå§‹åŒ–ç¼“å­˜
  //     await refreshCache()
  //     ctx.logger('baka').info(`ğŸ–¼ï¸ åˆå§‹åŠ è½½ ${imageCache.length} å¼ å›¾ç‰‡`)

  //     // 3. è®¾ç½®å®šæ—¶ç¼“å­˜åˆ·æ–°
  //     ctx.setInterval(refreshCache, config.cacheTime)
  //   } catch (error) {
  //     ctx.logger('baka').error('âŒ åˆå§‹åŒ–å¤±è´¥ï¼š', error)
  //     throw error
  //   }
  // }


  // const mimeTypeMap: Record<string, string> = {
  //   '.png': 'image/png',
  //   '.jpg': 'image/jpeg',
  //   '.jpeg': 'image/jpeg',
  //   '.gif': 'image/gif',
  //   '.webp': 'image/webp'
  // }

  // const refreshCache = async () => {
  //   try {
  //     const files = await fs.readdir(fullPath)
  //     const newCache: ImageInfo[] = []

  //     for (const file of files) {
  //       try {
  //         const filePath = path.join(fullPath, file)
  //         const stats = await fs.stat(filePath)
  //         const ext = path.extname(file).toLowerCase()

  //         // æ–‡ä»¶éªŒè¯
  //         if (!stats.isFile()) {
  //           ctx.logger('baka').debug(`â© è·³è¿‡éæ–‡ä»¶é¡¹ï¼š${file}`)
  //           continue
  //         }

  //         if (!['.png', '.jpg', '.jpeg', '.gif', '.webp'].includes(ext)) {
  //           ctx.logger('baka').debug(`â© è·³è¿‡éå›¾ç‰‡æ–‡ä»¶ï¼š${file}`)
  //           continue
  //         }

  //         if (stats.size > maxSize) {
  //           ctx.logger('baka').warn(`âš ï¸ å›¾ç‰‡è¿‡å¤§å·²è·³è¿‡ï¼š${file} (${formatSize(stats.size)})`)
  //           continue
  //         }

  //         newCache.push({
  //           filename: file,
  //           path: filePath,
  //           size: stats.size,
  //           mtime: stats.mtime
  //         })
  //       } catch (error) {
  //         ctx.logger('baka').error(`â— æ–‡ä»¶å¤„ç†é”™è¯¯ [${file}]ï¼š`, error)
  //       }
  //     }

  //     imageCache = newCache
  //     lastUpdate = Date.now()
  //     ctx.logger('baka').info(`ğŸ”„ ç¼“å­˜åˆ·æ–°å®Œæˆï¼Œæœ‰æ•ˆå›¾ç‰‡ï¼š${imageCache.length} å¼ `)
  //   } catch (error) {
  //     ctx.logger('baka').error('âŒ ç¼“å­˜åˆ·æ–°å¤±è´¥ï¼š', error)
  //   }
  // }




  // ctx.middleware(async (session) => {
  //   if (session.guildId !== config.targetGuild) {
  //     ctx.logger('baka').debug(`æ¶ˆæ¯æ¥è‡ªéç›®æ ‡ç¾¤ç»„ï¼š${session.guildId}`)
  //     return;
  //   }
  //   // 1. æ¶ˆæ¯è¿‡æ»¤
  //   if (!/^\s*baka\s*!*$/i.test(session.content)) {
  //     ctx.logger('baka').debug(`â­ï¸ å¿½ç•¥éè§¦å‘æ¶ˆæ¯ï¼š[${session.content}]`)
  //     return
  //   }

  //   ctx.logger('baka').info(`ğŸ¯ æ”¶åˆ° BAKA è¯·æ±‚ [ç”¨æˆ·ï¼š${session.userId}]`)

  //   try {
  //     // 2. ç¼“å­˜æ£€æŸ¥
  //     if (imageCache.length === 0) {
  //       ctx.logger('baka').warn('âš ï¸ è¯·æ±‚æ—¶å›¾ç‰‡ç¼“å­˜ä¸ºç©º')
  //       return h.text([
  //         'BAKAèƒ½é‡ä¸è¶³ï¼(Â´ï¼›Ï‰ï¼›`)',
  //         'è¯·ç®¡ç†å‘˜æ·»åŠ å›¾ç‰‡åˆ°ï¼š',
  //         `file://${pathToFileURL(fullPath)}`
  //       ].join('\n'))
  //     }

  //     // 3. éšæœºé€‰æ‹©å›¾ç‰‡
  //     const selected = imageCache[Math.floor(Math.random() * imageCache.length)]
  //     ctx.logger('baka').debug(`ğŸ² éšæœºé€‰æ‹©å›¾ç‰‡ï¼š${selected.filename}`)

  //     // 4. æ–‡ä»¶äºŒæ¬¡éªŒè¯
  //     try {
  //       await fs.access(selected.path)
  //     } catch {
  //       ctx.logger('baka').warn(`âš ï¸ å›¾ç‰‡æ–‡ä»¶å·²ä¸¢å¤±ï¼š${selected.filename}`)
  //       await refreshCache()
  //       return h.text('BAKAèƒ½é‡ç¥ç§˜æ¶ˆå¤±äº†... (ï¼ï¹ï¼œ)')
  //     }

  //     // 5. QQå¹³å°é€‚é…
  //     // if (session.platform === 'qq') {
  //     //   // // QQä¸“ç”¨ä¸Šä¼ æ–¹å¼
  //     //   // const asset = await session.bot.uploadAsset(selected.path)
  //     //   // return [
  //     //   //   h.image(asset.url),
  //     //   //   h.text(`BAKAèƒ½é‡æ³¨å…¥ï¼âœ¨ [${selected.filename}]`)
  //     //   // ]
  //     //   const buffer = await fs.readFile(selected.path)
  //     //   return h.image(`base64://${buffer.toString('base64')}`)
  //     // }

  //     // // å…¶ä»–å¹³å°é€šç”¨æ–¹å¼
  //     // return [
  //     //   h.image(pathToFileURL(selected.path).href),
  //     //   h.text(`BAKAèƒ½é‡æ³¨å…¥ï¼âœ¨ [${selected.filename}]`)
  //     // ]
  //     let imageElement: h
  //     if (session.platform === 'qq') {
  //       const buffer = await fs.readFile(selected.path)
  //       imageElement = h.image(`base64://${buffer.toString('base64')}`)
  //     } else {
  //       imageElement = h.image(pathToFileURL(selected.path).href)
  //     }

  //     return [
  //       imageElement,
  //       h.text(`BAKAèƒ½é‡æ³¨å…¥æˆåŠŸï¼âœ¨ [${selected.filename}]`),
  //       h.text(`ç¼“å­˜æ—¶é—´ï¼š${new Date(lastUpdate).toLocaleString()}`)
  //     ]

  //   } catch (error) {
  //     ctx.logger('baka').error('ğŸ’¥ å¤„ç†æµç¨‹å¼‚å¸¸ï¼š', error)
  //     return h.text([
  //       'BAKAç³»ç»Ÿå´©æºƒäº†ï¼(â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”»',
  //       'é”™è¯¯ä¿¡æ¯ï¼š',
  //       h('code',error.message)
  //     ].join('\n'))
  //   }
  // })

  // function formatSize(bytes: number): string {
  //   const units = ['B', 'KB', 'MB', 'GB']
  //   let size = bytes
  //   let unitIndex = 0
  //   while (size >= 1024 && unitIndex < units.length - 1) {
  //     size /= 1024
  //     unitIndex++
  //   }
  //   return `${size.toFixed(2)}${units[unitIndex]}`
  // }

  // initialize().catch(() => {
  //   ctx.logger('baka').
  //   error('âŒ æ’ä»¶å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯')
  // })

  // ctx.on('send', (session) => {
  //   ctx.logger('baka').debug('å‘é€æ¶ˆæ¯ï¼š', session.content)
  // })
  // æ ¸å¿ƒçŠ¶æ€
  // const fullPath = path.resolve(ctx.baseDir, config.storagePath)
  // const maxSize = config.maxSizeMB * 1024 * 1024
  // let imageCache: ImageInfo[] = []
  // let cacheVersion = 0
//   const fullPath = path.resolve(ctx.baseDir, config.storagePath)
//   const maxSize = config.maxSizeMB * 1024 * 1024
//   let imageCache: ImageInfo[] = []
//   let lastUpdate = 0
// // ================= åˆå§‹åŒ–æ¨¡å— =================
//   const initialize = async () => {
//     try {
//       // 1. åˆ›å»ºå­˜å‚¨ç›®å½•
//       await fs.mkdir(fullPath, { recursive: true })
//       ctx.logger('baka').info(`ğŸ“ å­˜å‚¨ç›®å½•å·²å°±ç»ªï¼š${pathToFileURL(fullPath)}`)

//       // 2. åˆå§‹åŒ–ç¼“å­˜
//       await refreshCache()
//       ctx.logger('baka').info(`ğŸ–¼ï¸ åˆå§‹åŠ è½½ ${imageCache.length} å¼ å›¾ç‰‡`)

//       // 3. è®¾ç½®å®šæ—¶ç¼“å­˜åˆ·æ–°
//       ctx.setInterval(refreshCache, config.cacheTime)
//     } catch (error) {
//       ctx.logger('baka').error('âŒ åˆå§‹åŒ–å¤±è´¥ï¼š', error)
//       throw error
//     }
//   }
//   // ================= ç¼“å­˜åˆ·æ–°æ¨¡å— =================
//   const refreshCache = async () => {
//     try {
//       const files = await fs.readdir(fullPath)
//       const newCache: ImageInfo[] = []
//       let validCount = 0
//       let errorCount = 0

//       for (const file of files) {
//         try {
//           const filePath = path.join(fullPath, file)
//           const stats = await fs.stat(filePath)
//           const ext = path.extname(file).toLowerCase()

//           // æ–‡ä»¶éªŒè¯
//           if (!stats.isFile()) {
//             ctx.logger('baka').debug(`â© è·³è¿‡éæ–‡ä»¶é¡¹ï¼š${file}`)
//             continue
//           }

//           if (!['.png', '.jpg', '.jpeg', '.gif', '.webp'].includes(ext)) {
//             ctx.logger('baka').debug(`â© è·³è¿‡éå›¾ç‰‡æ–‡ä»¶ï¼š${file}`)
//             continue
//           }

//           if (stats.size > maxSize) {
//             ctx.logger('baka').warn(`âš ï¸ å›¾ç‰‡è¿‡å¤§å·²è·³è¿‡ï¼š${file} (${formatSize(stats.size)})`)
//             continue
//           }

//           newCache.push({
//             filename: file,
//             path: filePath,
//             size: stats.size,
//             mtime: stats.mtime,
//             url: pathToFileURL(filePath).href
//           })
//           validCount++
//         } catch (error) {
//           ctx.logger('baka').error(`â— æ–‡ä»¶å¤„ç†é”™è¯¯ [${file}]ï¼š`, error)
//         }
//       }

//       imageCache = newCache
//       lastUpdate = Date.now()
//       ctx.logger('baka').info(`ğŸ”„ ç¼“å­˜åˆ·æ–°å®Œæˆï¼Œæœ‰æ•ˆå›¾ç‰‡ï¼š${imageCache.length} å¼ `)
//     } catch (error) {
//       ctx.logger('baka').error('âŒ ç¼“å­˜åˆ·æ–°å¤±è´¥ï¼š', error)
//     }
//   }

//   // ================= ç¼“å­˜åˆ·æ–°æ¨¡å— =================
//   // ================= ä¸šåŠ¡é€»è¾‘æ¨¡å— =================
//   ctx.middleware(async (session) => {
//     // 1. æ¶ˆæ¯è¿‡æ»¤
//     if (session.guildId !== config.targetGuild) {
//       return
//     }
//     if (!/^\s*baka\s*!*$/i.test(session.content)) {
//       ctx.logger('baka').debug(`â­ï¸ å¿½ç•¥éè§¦å‘æ¶ˆæ¯ï¼š[${session.content}]`)
//       return
//     }

//     ctx.logger('baka').info(`ğŸ¯ æ”¶åˆ° BAKA è¯·æ±‚ [ç”¨æˆ·ï¼š${session.userId}]`)

//     try {
//       // 2. ç¼“å­˜æ£€æŸ¥
//       if (imageCache.length === 0) {
//         ctx.logger('baka').warn('âš ï¸ è¯·æ±‚æ—¶å›¾ç‰‡ç¼“å­˜ä¸ºç©º')
//         return h.text([
//           'BAKAèƒ½é‡ä¸è¶³ï¼(Â´ï¼›Ï‰ï¼›`)',
//           'è¯·ç®¡ç†å‘˜æ·»åŠ å›¾ç‰‡åˆ°ï¼š',
//           `file://${pathToFileURL(fullPath)}`
//         ].join('\n'))
//       }

//       // 3. éšæœºé€‰æ‹©å›¾ç‰‡
//       const selected = imageCache[Math.floor(Math.random() * imageCache.length)]
//       ctx.logger('baka').debug(`ğŸ² éšæœºé€‰æ‹©å›¾ç‰‡ï¼š${selected.filename}`)

//       // 4. æ–‡ä»¶äºŒæ¬¡éªŒè¯
//       try {
//         await fs.access(selected.path)
//       } catch {
//         ctx.logger('baka').warn(`âš ï¸ å›¾ç‰‡æ–‡ä»¶å·²ä¸¢å¤±ï¼š${selected.filename}`)
//         await refreshCache()
//         return h.text('BAKAèƒ½é‡ç¥ç§˜æ¶ˆå¤±äº†... (ï¼ï¹ï¼œ)')
//       }


//       let imageElement: h
//       if (['onebot', 'qq'].includes(session.platform)) {
//         // QQå¹³å°éœ€è¦ç‰¹æ®Šå¤„ç†
//         imageElement = h.image(selected.url) + h.text(' ')
//       } else {
//         imageElement = h.image(selected.url)
//       }
  
//       return [
//         imageElement,
//         h.text(`BAKAèƒ½é‡æ³¨å…¥æˆåŠŸï¼âœ¨ [${selected.filename}]`),
//         h.text(`ç¼“å­˜æ—¶é—´ï¼š${new Date(lastUpdate).toLocaleString()}`)
//       ]
//       // 5. QQå¹³å°é€‚é…
//       // if (session.platform === 'qq') {
//       //   // QQä¸“ç”¨ä¸Šä¼ æ–¹å¼
//       //   const asset = await session.bot.uploadAsset(selected.path)
//       //   return [
//       //     h.image(asset.url),
//       //     h.text(`BAKAèƒ½é‡æ³¨å…¥ï¼âœ¨ [${selected.filename}]`)
//       //   ]
//       // }

//       // // å…¶ä»–å¹³å°é€šç”¨æ–¹å¼
//       // return [
//       //   h.image(pathToFileURL(selected.path).href),
//       //   h.text(`BAKAèƒ½é‡æ³¨å…¥ï¼âœ¨ [${selected.filename}]`)
//       // ]

//     } catch (error) {
//       ctx.logger('baka').error('ğŸ’¥ å¤„ç†æµç¨‹å¼‚å¸¸ï¼š', error)
//       return h.text([
//         'BAKAç³»ç»Ÿå´©æºƒäº†ï¼(â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”»',
//         'é”™è¯¯ä¿¡æ¯ï¼š',
//         h('code',error.message)
//       ].join('\n'))
//     }
//   })

//     // ================= å·¥å…·å‡½æ•° =================
//   function formatSize(bytes: number): string {
//       const units = ['B', 'KB', 'MB', 'GB']
//       let size = bytes
//       let unitIndex = 0
//       while (size >= 1024 && unitIndex < units.length - 1) {
//         size /= 1024
//         unitIndex++
//       }
//       return `${size.toFixed(2)}${units[unitIndex]}`
//   }
//       // ================= å¯åŠ¨åˆå§‹åŒ– =================
//   initialize().catch(() => {
//     ctx.logger('baka').error('âŒ æ’ä»¶å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯')
//   })


//   // æœåŠ¡åˆå§‹åŒ–
//   ctx.on('ready', async () => {
//     await initializeStorage()
//     await refreshCache()
//     ctx.setInterval(() => refreshCache(), config.cacheTime)

//     // æ³¨å†Œè°ƒè¯•å‘½ä»¤
//     ctx.command('baka/reload', 'æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜')
//       .action(async ({ session }) => {
//         await refreshCache(true)
//         return `Cache reloaded. ${imageCache.length} images available.`
//       })
//   })
  // // åˆ›å»ºæ•°æ®åº“è¡¨
  // ctx.model.extend('baka_images', {
  //   id: 'unsigned',
  //   filename: 'string',
  //   originalname: 'string',
  //   adder: 'string',
  //   timestamp: 'timestamp',
  // }, { autoInc: true })


  // // æœ€è¿‘å‘é€è®°å½•
  // const recentSent: number[] = []

  // ctx.middleware(async (session, next) => {
  //   if (session.guildId !== config.targetGuild) return next()
  //   if (session.content.toLowerCase() !== 'baka') return next()

  //   try {
  //     const allImages = await ctx.database.get('baka_images', {})
  //     if (allImages.length === 0) return next()

  //     const available = allImages.filter(img => !recentSent.includes(img.id))
  //     const candidates = available.length > 0 ? available : allImages
  //     const selected = candidates[Math.floor(Math.random() * candidates.length)]

  //     // æ›´æ–°å‘é€è®°å½•
  //     recentSent.push(selected.id)
  //     if (recentSent.length > config.maxRepeat) recentSent.shift()

  //     // æ„é€ æœ¬åœ°æ–‡ä»¶è·¯å¾„
  //     const filePath = path.join(fullPath, selected.filename)
  //     await session.send(h.image(filePath))
  //     return
  //   } catch (error) {
  //     ctx.logger('baka').error('å›¾ç‰‡å‘é€å¤±è´¥:', error)
  //   }
  //   return next()
  // })

  // // æ·»åŠ å›¾ç‰‡æŒ‡ä»¤ï¼ˆé€šè¿‡æ–‡ä»¶ä¸Šä¼ ï¼‰
  // ctx.command('baka-add', 'æ·»åŠ æœ¬åœ°BAKAå›¾ç‰‡')
  //   .alias('æ·»åŠ çªéœ²è¯ºå›¾')
  //   .usage('è¯·ç›´æ¥å‘é€å›¾ç‰‡æ–‡ä»¶ï¼Œæ”¯æŒæ ¼å¼ï¼šjpg/png/gif')
  //   .action(async ({ session }) => {
  //     if (session.guildId !== config.targetGuild) {
  //       return 'æ­¤å‘½ä»¤åªèƒ½åœ¨æŒ‡å®šç¾¤ç»„ä½¿ç”¨'
  //     }

  //     // ä½¿ç”¨ç±»å‹æ–­è¨€è·å–å›¾ç‰‡å…ƒç´ 
  //     const imageElement = session.elements.find((e): e is ImageElement => e.type === 'image')
  //     if (!imageElement) return 'è¯·ç›´æ¥å‘é€å›¾ç‰‡æ–‡ä»¶'

  //     try {
  //       // ä¸‹è½½æ–‡ä»¶
  //       const response = await ctx.http.get(imageElement.attrs.url, { responseType: 'arraybuffer' })
  //       const buffer = Buffer.from(response)

  //       // éªŒè¯æ–‡ä»¶ç±»å‹
  //       const ext = validateImageType(buffer)
  //       if (!ext) return 'ä»…æ”¯æŒ JPG/PNG/GIF æ ¼å¼å›¾ç‰‡'

  //       // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
  //       const filename = `${randomUUID()}.${ext}`
  //        // è·å–åŸå§‹æ–‡ä»¶åï¼ˆå¤šæ¥æºå…¼å®¹ï¼‰
  //       const originalname = imageElement.attrs.filename || path.basename(new URL(imageElement.attrs.url).pathname) || filename

  //       // ä¿å­˜æ–‡ä»¶
  //       await fs.writeFile(path.join(fullPath, filename), buffer)

  //       // åˆ›å»ºæ•°æ®åº“è®°å½•
  //       const record = await ctx.database.create('baka_images', {
  //         filename,
  //         originalname,
  //         adder: session.userId,
  //         timestamp: new Date(),
  //       })

  //       // è¿”å›æ·»åŠ ç»“æœ
  //       await session.send([
  //         `âœ… å›¾ç‰‡æ·»åŠ æˆåŠŸï¼(ID: ${record.id})`,
  //         h.image(path.join(fullPath, filename)),
  //         `åŸå§‹æ–‡ä»¶åï¼š${originalname}`,
  //         `æ·»åŠ è€…ï¼š${session.username}`,
  //         `å½“å‰å›¾åº“æ€»æ•°ï¼š`
  //       ])
  //     } catch (error) {
  //       ctx.logger('baka').error('æ·»åŠ å¤±è´¥:', error)
  //       return 'å›¾ç‰‡æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼'
  //     }
  //   })
  //   // å›¾ç‰‡ç±»å‹éªŒè¯å‡½æ•°
  // function validateImageType(buffer: Buffer): string | null {
  //   const header = buffer.subarray(0, 4).toString('hex')
  //   switch (header) {
  //     case 'ffd8ffe0': case 'ffd8ffe1': case 'ffd8ffe2':
  //       return 'jpg'
  //     case '89504e47':
  //       return 'png'
  //     case '47494638':
  //       return 'gif'
  //     default:
  //       return null
  //   }
  // }

  // // ç®¡ç†æŒ‡ä»¤ï¼ˆä¿ç•™ä¹‹å‰çš„åˆ é™¤å’Œåˆ—è¡¨åŠŸèƒ½ï¼Œéœ€è¦è°ƒæ•´æ–‡ä»¶è·¯å¾„ï¼‰
  // ctx.command('baka-manage', 'BAKAå›¾ç‰‡ç®¡ç†', { authority: 1 })
  //   .subcommand('.delete <id:number>', 'åˆ é™¤å›¾ç‰‡', { authority: 1 })
  //   .action(async ({ session }, id) => {
  //     const [record] = await ctx.database.get('baka_images', { id })
  //     if (!record) return 'æœªæ‰¾åˆ°è¯¥å›¾ç‰‡'

  //     try {
  //       // åˆ é™¤æ–‡ä»¶
  //       await fs.unlink(path.join(fullPath, record.filename))
  //       // åˆ é™¤æ•°æ®åº“è®°å½•
  //       await ctx.database.remove('baka_images', { id })

  //       // æ›´æ–°æœ€è¿‘å‘é€è®°å½•
  //       const index = recentSent.indexOf(id)
  //       if (index > -1) recentSent.splice(index, 1)

  //       return `âœ… å·²åˆ é™¤å›¾ç‰‡ ID: ${id} (${record.originalname})`
  //     } catch (error) {
  //       ctx.logger('baka').error('åˆ é™¤å¤±è´¥:', error)
  //       return 'åˆ é™¤æ“ä½œå¤±è´¥'
  //     }
  //   })

  // // æ¯å¤©å‡Œæ™¨æ¸…ç†æ— æ•ˆè®°å½•
  // ctx.setInterval(async () => {
  //   const records = await ctx.database.get('baka_images', {})
  //   const files = await fs.readdir(fullPath)
    
  //   // æ¸…ç†æ•°æ®åº“ä¸­æœ‰è®°å½•ä½†æ–‡ä»¶ä¸å­˜åœ¨çš„æ¡ç›®
  //   const toDelete = records.filter(r => !files.includes(r.filename))
  //   await ctx.database.remove('baka_images', {
  //     id: { $in: toDelete.map(r => r.id) }
  //   })
  // }, 24 * 60 * 60 * 1000)


  // ctx.command('baka-manage.backup', 'å¤‡ä»½å›¾ç‰‡åº“')
  //   .action(async () => {
  //     const backupPath = path.join(fullPath, 'backup', Date.now().toString())
  //     await fs.mkdir(backupPath, { recursive: true })
      
  //     const files = await fs.readdir(fullPath)
  //     await Promise.all(files.map(async (file) => {
  //       if (file === 'backup') return
  //       await fs.copyFile(
  //         path.join(fullPath, file),
  //         path.join(backupPath, file)
  //       )
  //     })
  //   )
  //     return `å¤‡ä»½å®Œæˆï¼Œå…±å¤‡ä»½ ${files.length} ä¸ªæ–‡ä»¶`
  // })
    //è‡ªåŠ¨æ·»åŠ 2æœvipæŒ‡ä»¤
  //session.send('é’äº‘å®¢å…³é—­å®Œæˆ' + h('at', { id: session.userId }));
  // ctx.command('+v <server:string> <message:string> [day:number]', 'è™šæ‹Ÿå‘½ä»¤ç¤ºä¾‹', { authority: 1 })
  // .action(async ({ session }, server, message, day) => {
  //   // 1. å‘é€æ ¼å¼åŒ–å“åº”
  //   await session.send(`*+v ${server} ${message} ${day || ''}`.trim())

  //   // 2. ä½¿ç”¨setTimeoutå®ç°å»¶è¿Ÿï¼ˆKoishiæ¨èæ–¹å¼ï¼‰
  //   ctx.setTimeout(async () => {
  //     await session.send(`*check ${server}`)
  //   }, 2000)
  // })
  // ctx.command('-v <server:string> <message:string> [day:number]', 'è™šæ‹Ÿå‘½ä»¤ç¤ºä¾‹', { authority: 1 })
  // .action(async ({ session }, server, message, day) => {
  //   // 1. å‘é€æ ¼å¼åŒ–å“åº”
  //   await session.send(`*+v ${server} ${message} ${day || ''}`.trim())

  //   // 2. ä½¿ç”¨setTimeoutå®ç°å»¶è¿Ÿï¼ˆKoishiæ¨èæ–¹å¼ï¼‰
  //   ctx.setTimeout(async () => {
  //     await session.send(`*check ${server}`)
  //   }, 2000)
  // })
  // import { Context, Schema } from 'koishi'

// export const name = 'warntoban'

// export interface Config {}

// export const inject = ['database']

// export const Config: Schema<Config> = Schema.object({})


// // å¼ºåŒ–æ­£åˆ™è¡¨è¾¾å¼ï¼Œå…è®¸çµæ´»ç©ºæ ¼
// const buildPattern = (server: string, player: string, reason: string) => {
//   return new RegExp(
//     `åœ¨æœåŠ¡å™¨\\s*${server}\\s*ä¸­è¸¢å‡ºç©å®¶\\s*${player}\\s*æˆåŠŸåŸå› \\s*ï¼š\\s*${reason}`
//   )
// }

// // å£°æ˜æ•°æ®åº“è¡¨ç»“æ„
// declare module 'koishi' {
//   interface Tables {
//     ban_records: {
//       id: number
//       server: string
//       player: string
//       reason: string
//       timestamp: Date
//     }
//   }
// }

// export function apply(ctx: Context) {
//   // write your plugin here
//   // åˆ›å»ºæ•°æ®åº“è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
//   ctx.model.extend('ban_records', {
//     id: 'unsigned',
//     server: 'string',
//     player: 'string',
//     reason: 'string',
//     timestamp: 'timestamp',
//   }, {
//     autoInc: true,
//   })
//   // é…ç½®ç›‘å¬å‚æ•°
//   const config = {
//     targetGuild: '427897235',    // ç›®æ ‡QQç¾¤å·
//     adminUserId: '974111779',    // ç®¡ç†å‘˜ç”¨æˆ·ID
//     serverNumber: '2',           // ç›‘æ§çš„æœåŠ¡å™¨ç¼–å·
//     playerName: 'aiyachengle',   // ç›‘æ§çš„ç©å®¶ID
//     triggerReason: 'ç¦ç”¨kb',      // è§¦å‘å…³é”®è¯
//     maxViolations: 2,            // æœ€å¤§å…è®¸è¿è§„æ¬¡æ•°
//   }
//   // ä½¿ç”¨æ›´å®½æ¾çš„æ­£åˆ™
//   const kickPattern = buildPattern(
//     config.serverNumber,
//     config.playerName,
//     config.triggerReason
//   )
//   // æ³¨å†Œæ¶ˆæ¯ä¸­é—´ä»¶
//   ctx.middleware(async (session, next) => {
//     // 1. å‰ç½®æ¡ä»¶æ£€æŸ¥
//     if (session.guildId !== config.targetGuild) {
//       ctx.logger('ban-monitor').debug('éç›®æ ‡ç¾¤ç»„æ¶ˆæ¯ï¼Œè·³è¿‡å¤„ç†')
//       return next()
//     }

//     if (session.userId !== config.adminUserId) {
//       ctx.logger('ban-monitor').debug('éç®¡ç†å‘˜æ¶ˆæ¯ï¼Œè·³è¿‡å¤„ç†')
//       return next()
//     }

//     // 2. æ¶ˆæ¯å†…å®¹åŒ¹é…
//     if (!kickPattern.test(session.content)) {
//       ctx.logger('ban-monitor').debug('æ¶ˆæ¯å†…å®¹ä¸åŒ¹é…è§„åˆ™')
//       return next()
//     }

//     ctx.logger('ban-monitor').info('æ£€æµ‹åˆ°ç¬¦åˆæ¡ä»¶çš„è¸¢äººæ“ä½œ')

//     try {
//       // 3. åˆ›å»ºæ–°è®°å½•
//       await ctx.database.create('ban_records', {
//         server: config.serverNumber,
//         player: config.playerName,
//         reason: config.triggerReason,
//         timestamp: new Date(),
//       })

//       // 4. æŸ¥è¯¢å†å²è®°å½•
//       const records = await ctx.database.get('ban_records', {
//         server: config.serverNumber,
//         player: config.playerName,
//       })

//       // 5. æ£€æŸ¥è¿è§„æ¬¡æ•°
//       if (records.length >= config.maxViolations) {
//         const recordList = records.map((r, index) => 
//           `è¿è§„ #${index + 1}
//           æ—¶é—´ï¼š${r.timestamp.toLocaleString()}
//           åŸå› ï¼š${r.reason}`
//         ).join('\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n')

//         await session.send([
//           `[${config.serverNumber} æœ] ç©å®¶ ${config.playerName} è¾¾åˆ°å°ç¦æ ‡å‡†ï¼`,
//           `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,
//           recordList,
//           `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,
//           `ç´¯è®¡è¿è§„æ¬¡æ•°ï¼š${records.length} æ¬¡`,
//           `è¯·ç«‹å³æ‰§è¡Œå°ç¦æ“ä½œï¼`,
//         ].join('\n'))

//         ctx.logger('ban-monitor').info('å·²å‘é€å°ç¦æé†’')
//       }
//     } catch (error) {
//       ctx.logger('ban-monitor').error('æ•°æ®åº“æ“ä½œå¤±è´¥:', error)
//       await session.send('âš ï¸ è¿è§„è®°å½•ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ï¼')
//     }

//     return next()
//   })
//   // æ·»åŠ è°ƒè¯•å‘½ä»¤ï¼ˆå¯é€‰ï¼‰
//   ctx.command('ban-records', 'æŸ¥çœ‹è¿è§„è®°å½•')
//     .action(async ({ session }) => {
//       const records = await ctx.database.get('ban_records', {
//         server: config.serverNumber,
//         player: config.playerName,
//       })
      
//       return records.length 
//         ? `æ‰¾åˆ° ${records.length} æ¡è®°å½•ï¼š\n` +
//           records.map(r => 
//             `[${r.timestamp.toLocaleString()}] ${r.reason}`
//           ).join('\n')
//         : 'æš‚æ— è¿è§„è®°å½•'
//     })
// }
// import { Context, Schema } from 'koishi'
  // // åˆ›å»ºæ•°æ®åº“è¡¨
  // ctx.model.extend('baka_images', {
  //   id: 'unsigned',
  //   filename: 'string',
  //   originalname: 'string',
  //   adder: 'string',
  //   timestamp: 'timestamp',
  // }, { autoInc: true })


  // // æœ€è¿‘å‘é€è®°å½•
  // const recentSent: number[] = []

  // ctx.middleware(async (session, next) => {
  //   if (session.guildId !== config.targetGuild) return next()
  //   if (session.content.toLowerCase() !== 'baka') return next()

  //   try {
  //     const allImages = await ctx.database.get('baka_images', {})
  //     if (allImages.length === 0) return next()

  //     const available = allImages.filter(img => !recentSent.includes(img.id))
  //     const candidates = available.length > 0 ? available : allImages
  //     const selected = candidates[Math.floor(Math.random() * candidates.length)]

  //     // æ›´æ–°å‘é€è®°å½•
  //     recentSent.push(selected.id)
  //     if (recentSent.length > config.maxRepeat) recentSent.shift()

  //     // æ„é€ æœ¬åœ°æ–‡ä»¶è·¯å¾„
  //     const filePath = path.join(fullPath, selected.filename)
  //     await session.send(h.image(filePath))
  //     return
  //   } catch (error) {
  //     ctx.logger('baka').error('å›¾ç‰‡å‘é€å¤±è´¥:', error)
  //   }
  //   return next()
  // })

  // // æ·»åŠ å›¾ç‰‡æŒ‡ä»¤ï¼ˆé€šè¿‡æ–‡ä»¶ä¸Šä¼ ï¼‰
  // ctx.command('baka-add', 'æ·»åŠ æœ¬åœ°BAKAå›¾ç‰‡')
  //   .alias('æ·»åŠ çªéœ²è¯ºå›¾')
  //   .usage('è¯·ç›´æ¥å‘é€å›¾ç‰‡æ–‡ä»¶ï¼Œæ”¯æŒæ ¼å¼ï¼šjpg/png/gif')
  //   .action(async ({ session }) => {
  //     if (session.guildId !== config.targetGuild) {
  //       return 'æ­¤å‘½ä»¤åªèƒ½åœ¨æŒ‡å®šç¾¤ç»„ä½¿ç”¨'
  //     }

  //     // ä½¿ç”¨ç±»å‹æ–­è¨€è·å–å›¾ç‰‡å…ƒç´ 
  //     const imageElement = session.elements.find((e): e is ImageElement => e.type === 'image')
  //     if (!imageElement) return 'è¯·ç›´æ¥å‘é€å›¾ç‰‡æ–‡ä»¶'

  //     try {
  //       // ä¸‹è½½æ–‡ä»¶
  //       const response = await ctx.http.get(imageElement.attrs.url, { responseType: 'arraybuffer' })
  //       const buffer = Buffer.from(response)

  //       // éªŒè¯æ–‡ä»¶ç±»å‹
  //       const ext = validateImageType(buffer)
  //       if (!ext) return 'ä»…æ”¯æŒ JPG/PNG/GIF æ ¼å¼å›¾ç‰‡'

  //       // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
  //       const filename = `${randomUUID()}.${ext}`
  //        // è·å–åŸå§‹æ–‡ä»¶åï¼ˆå¤šæ¥æºå…¼å®¹ï¼‰
  //       const originalname = imageElement.attrs.filename || path.basename(new URL(imageElement.attrs.url).pathname) || filename

  //       // ä¿å­˜æ–‡ä»¶
  //       await fs.writeFile(path.join(fullPath, filename), buffer)

  //       // åˆ›å»ºæ•°æ®åº“è®°å½•
  //       const record = await ctx.database.create('baka_images', {
  //         filename,
  //         originalname,
  //         adder: session.userId,
  //         timestamp: new Date(),
  //       })

  //       // è¿”å›æ·»åŠ ç»“æœ
  //       await session.send([
  //         `âœ… å›¾ç‰‡æ·»åŠ æˆåŠŸï¼(ID: ${record.id})`,
  //         h.image(path.join(fullPath, filename)),
  //         `åŸå§‹æ–‡ä»¶åï¼š${originalname}`,
  //         `æ·»åŠ è€…ï¼š${session.username}`,
  //         `å½“å‰å›¾åº“æ€»æ•°ï¼š`
  //       ])
  //     } catch (error) {
  //       ctx.logger('baka').error('æ·»åŠ å¤±è´¥:', error)
  //       return 'å›¾ç‰‡æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼'
  //     }
  //   })
  //   // å›¾ç‰‡ç±»å‹éªŒè¯å‡½æ•°
  // function validateImageType(buffer: Buffer): string | null {
  //   const header = buffer.subarray(0, 4).toString('hex')
  //   switch (header) {
  //     case 'ffd8ffe0': case 'ffd8ffe1': case 'ffd8ffe2':
  //       return 'jpg'
  //     case '89504e47':
  //       return 'png'
  //     case '47494638':
  //       return 'gif'
  //     default:
  //       return null
  //   }
  // }

  // // ç®¡ç†æŒ‡ä»¤ï¼ˆä¿ç•™ä¹‹å‰çš„åˆ é™¤å’Œåˆ—è¡¨åŠŸèƒ½ï¼Œéœ€è¦è°ƒæ•´æ–‡ä»¶è·¯å¾„ï¼‰
  // ctx.command('baka-manage', 'BAKAå›¾ç‰‡ç®¡ç†', { authority: 1 })
  //   .subcommand('.delete <id:number>', 'åˆ é™¤å›¾ç‰‡', { authority: 1 })
  //   .action(async ({ session }, id) => {
  //     const [record] = await ctx.database.get('baka_images', { id })
  //     if (!record) return 'æœªæ‰¾åˆ°è¯¥å›¾ç‰‡'

  //     try {
  //       // åˆ é™¤æ–‡ä»¶
  //       await fs.unlink(path.join(fullPath, record.filename))
  //       // åˆ é™¤æ•°æ®åº“è®°å½•
  //       await ctx.database.remove('baka_images', { id })

  //       // æ›´æ–°æœ€è¿‘å‘é€è®°å½•
  //       const index = recentSent.indexOf(id)
  //       if (index > -1) recentSent.splice(index, 1)

  //       return `âœ… å·²åˆ é™¤å›¾ç‰‡ ID: ${id} (${record.originalname})`
  //     } catch (error) {
  //       ctx.logger('baka').error('åˆ é™¤å¤±è´¥:', error)
  //       return 'åˆ é™¤æ“ä½œå¤±è´¥'
  //     }
  //   })

  // // æ¯å¤©å‡Œæ™¨æ¸…ç†æ— æ•ˆè®°å½•
  // ctx.setInterval(async () => {
  //   const records = await ctx.database.get('baka_images', {})
  //   const files = await fs.readdir(fullPath)
    
  //   // æ¸…ç†æ•°æ®åº“ä¸­æœ‰è®°å½•ä½†æ–‡ä»¶ä¸å­˜åœ¨çš„æ¡ç›®
  //   const toDelete = records.filter(r => !files.includes(r.filename))
  //   await ctx.database.remove('baka_images', {
  //     id: { $in: toDelete.map(r => r.id) }
  //   })
  // }, 24 * 60 * 60 * 1000)


  // ctx.command('baka-manage.backup', 'å¤‡ä»½å›¾ç‰‡åº“')
  //   .action(async () => {
  //     const backupPath = path.join(fullPath, 'backup', Date.now().toString())
  //     await fs.mkdir(backupPath, { recursive: true })
      
  //     const files = await fs.readdir(fullPath)
  //     await Promise.all(files.map(async (file) => {
  //       if (file === 'backup') return
  //       await fs.copyFile(
  //         path.join(fullPath, file),
  //         path.join(backupPath, file)
  //       )
  //     })
  //   )
  //     return `å¤‡ä»½å®Œæˆï¼Œå…±å¤‡ä»½ ${files.length} ä¸ªæ–‡ä»¶`
  // })
      const role = session.event?.member?.roles;
    if(role.includes('member')){
        await session.send('æƒé™ä¸è¶³')
    } 
      // ctx.middleware(async (session, next) => {
  //   if (session.guildId !== config.targetGuild) {
  //     ctx.logger('ban').debug(`åŠ væ¶ˆæ¯æ¥è‡ªéç›®æ ‡ç¾¤ç»„ï¼š${session.guildId}`)
  //     return next()
  //   }
  //   const message = session.content
  //   if (message.startsWith("+v ")) {
  //     const role = session.event?.member?.roles;
  //     if(role.includes('member')){
  //       await session.send('æƒé™ä¸è¶³')
  //       return next();
  //     } 
  //     else {
  //       // æå– server, message, å’Œå¯é€‰çš„ day å‚æ•°
  //       const parts = message.split(" ");
  //       const server = parts[1];
  //       const messageContent = parts[2];
  //       const day = parts.length > 3 ? parseInt(parts[3]) : undefined;
    
  //       // å‘é€æ ¼å¼åŒ–åçš„æ¶ˆæ¯
  //       await session.send(`*+v ${server} ${messageContent} ${day || ''}`.trim());
    
  //       // ä½¿ç”¨ setTimeout å®ç° 2 ç§’å»¶è¿Ÿ
  //       ctx.setTimeout(async () => {
  //         await session.send(`*check ${server}`);
  //       }, 2000);
    
  //       return;
  //     }
  //   }
  //   // å¦åˆ™ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
  //   await next();
  // });
  // ctx.middleware(async (session, next) => {
  //   if (session.guildId !== config.targetGuild) {
  //     ctx.logger('ban').debug(`åŠ væ¶ˆæ¯æ¥è‡ªéç›®æ ‡ç¾¤ç»„ï¼š${session.guildId}`)
  //     return next()
  //   }
  //   const message = session.content
  //   if (message.startsWith("-v ")) {
  //     const role = session.event?.member?.roles;
  //     if(role.includes('member')){
  //       await session.send('æƒé™ä¸è¶³')
  //       return next();
  //     } 
  //     else {
  //       // æå– server, message, å’Œå¯é€‰çš„ day å‚æ•°
  //       const parts = message.split(" ");
  //       const server = parts[1];
  //       const messageContent = parts[2];
  //       const day = parts.length > 3 ? parseInt(parts[3]) : undefined;
    
  //       // å‘é€æ ¼å¼åŒ–åçš„æ¶ˆæ¯
  //       await session.send(`*-v ${server} ${messageContent} ${day || ''}`.trim());
    
  //       // ä½¿ç”¨ setTimeout å®ç° 2 ç§’å»¶è¿Ÿ
  //       ctx.setTimeout(async () => {
  //         await session.send(`*check ${server}`);
  //       }, 2000);
    
  //       return;
  //     }
  //   }
  //   // å¦åˆ™ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
  //   await next();
  // });